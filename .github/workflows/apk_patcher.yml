name: Patch and Sign APKs

on:
  schedule:
    - cron: '0 4 * * *'  # Runs daily at 4 AM UTC
  workflow_dispatch:
    inputs:
      app_id:
        description: 'Specific app ID to process (leave empty for all)'
        required: false
        default: ''

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.find.outputs.apps }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Find registered apps
        id: find
        run: |
          if[ -n "${{ github.event.inputs.app_id }}" ]; then
            APPS='["${{ github.event.inputs.app_id }}"]'
          else
            APPS=$(ls apps/*/app.json 2>/dev/null | xargs -I{} dirname {} | xargs -I{} basename {} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          echo "apps=$APPS" >> $GITHUB_OUTPUT
          echo "Discovered apps: $APPS"

  build:
    needs: discover
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        app: ${{ fromJson(needs.discover.outputs.apps) }}
      fail-fast: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install System Dependencies
        run: |
          pip install -r requirements.txt
          npm install -g apk-mitm

      - name: Check for updates & download
        id: check_version
        run: python run.py --app ${{ matrix.app }} --step download

      - name: Download Latest Apktool & UberSigner
        if: steps.check_version.outputs.update_needed == 'true'
        run: |
          APKTOOL_URL=$(curl -s https://api.github.com/repos/iBotPeaches/Apktool/releases/latest | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          wget -q "$APKTOOL_URL" -O apktool.jar
          UBER_URL=$(curl -s https://api.github.com/repos/patrickfav/uber-apk-signer/releases/latest | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          wget -q "$UBER_URL" -O ubersigner.jar

      - name: Apply WhatsApp Patcher (Schwartzblat)
        if: steps.check_version.outputs.update_needed == 'true' && matrix.app == 'whatsapp'
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"

          echo "[*] Cloning WhatsAppPatcher with submodules..."
          git clone --recurse-submodules https://github.com/Schwartzblat/WhatsAppPatcher.git
          cd WhatsAppPatcher

          echo "[*] Installing Patcher Dependencies..."
          pip install -r requirements.txt
          pip install stitch-test --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple

          echo "[*] Patching Androguard Bug in WhatsAppPatcher..."
          # סקריפט שעוקף את הניסיון לקרוא את קובץ המשאבים עם ARSCParser שקורס
          cat << 'EOF' > patch_androguard.py
import os
file_path = 'artifactory_generator/firebase_params.py'
with open(file_path, 'r') as f:
    content = f.read()

content = content.replace('resources = ARSCParser(resources_path.read_bytes())', 'pass')
content = content.replace("_, original_google_api_key = resources.get_string(package_name, 'google_api_key')", 'pass')
content = content.replace("artifacts['ORIGINAL_API_KEY'] = original_google_api_key", "artifacts['ORIGINAL_API_KEY'] = 'dummy_key'")

with open(file_path, 'w') as f:
    f.write(content)
EOF
          python3 patch_androguard.py

          echo "[*] Running Patcher on ../latest.apk ..."
          python3 main.py -p ../latest.apk -o ../latest_patched.apk --no-sign
          
          cd ..
          if [ -f "latest_patched.apk" ]; then
            echo "[+] WhatsApp Patch successful. Replacing original APK."
            mv latest_patched.apk latest.apk
          else
            echo "[-] WhatsApp Patch failed. Output file not found."
            exit 1
          fi

      - name: Decode APK
        if: steps.check_version.outputs.update_needed == 'true'
        run: java -jar apktool.jar d -f latest.apk -o build_output

      - name: Apply patch
        if: steps.check_version.outputs.update_needed == 'true'
        run: python run.py --app ${{ matrix.app }} --step patch

      - name: Repack APK
        if: steps.check_version.outputs.update_needed == 'true'
        run: java -jar apktool.jar b build_output -o patched_unsigned.apk

      - name: Decode Keystore
        if: steps.check_version.outputs.update_needed == 'true'
        env:
          RELEASE_KEYSTORE: ${{ secrets.RELEASE_KEYSTORE }}
        run: echo "$RELEASE_KEYSTORE" | base64 --decode > my_keystore.jks

      - name: Sign with UberApkSigner
        if: steps.check_version.outputs.update_needed == 'true'
        run: |
          java -jar ubersigner.jar \
            -a patched_unsigned.apk \
            --ks my_keystore.jks \
            --ksAlias ${{ secrets.KEY_ALIAS }} \
            --ksKeyPass ${{ secrets.KEY_PASSWORD }} \
            --ksPass ${{ secrets.KEYSTORE_PASSWORD }}

          mkdir -p release
          mv patched_unsigned-aligned-signed.apk release/${{ matrix.app }}-patched-${{ steps.check_version.outputs.new_version }}.apk

      - name: Update status on success
        if: steps.check_version.outputs.update_needed == 'true' && success()
        run: |
          python -c "
          from core.utils import update_status
          update_status('apps/${{ matrix.app }}/status.json', success=True)
          "

      - name: Update version file
        if: steps.check_version.outputs.update_needed == 'true' && success()
        run: echo "${{ steps.check_version.outputs.new_version }}" > apps/${{ matrix.app }}/version.txt

      - name: Update status on failure
        if: failure()
        run: |
          FAILED_VER="${{ steps.check_version.outputs.new_version || 'unknown' }}"
          python -c "
          from core.utils import update_status
          update_status('apps/${{ matrix.app }}/status.json', success=False, failed_version='$FAILED_VER', error_message='Patching or building failed')
          "

      - name: Commit version & status updates
        if: always()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add apps/${{ matrix.app }}/version.txt apps/${{ matrix.app }}/status.json
          git commit -m "[${{ matrix.app }}] Update to ${{ steps.check_version.outputs.new_version || 'status update' }}" || echo "No changes to commit"
          
          git pull origin main --rebase -X theirs
          git push origin HEAD:main

      - name: Create tag
        if: steps.check_version.outputs.update_needed == 'true' && success()
        run: |
          git pull origin main --rebase -X theirs
          git tag ${{ matrix.app }}-v${{ steps.check_version.outputs.new_version }}
          git push origin --tags

      - name: Create GitHub Release
        if: steps.check_version.outputs.update_needed == 'true' && success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.app }}-v${{ steps.check_version.outputs.new_version }}
          name: "${{ matrix.app }} ${{ steps.check_version.outputs.new_version }}"
          files: release/*.apk
          body: "Automated patch for ${{ matrix.app }} version ${{ steps.check_version.outputs.new_version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-listing:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Update listing
        run: python run.py --update-listing

      - name: Commit & Push apps.json
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add apps.json
          git commit -m "update apps.json listing [skip ci]" || echo "No changes to commit"
          
          git pull origin main --rebase -X theirs
          git push origin HEAD:main
