## File: .github/workflows/apk_patcher.yml
name: Patch and Sign APKs

on:
  schedule:
    - cron: '0 4 * * *'  # Runs daily at 4 AM UTC
  workflow_dispatch:
    inputs:
      app_id:
        description: 'Specific app ID to process (leave empty for all)'
        required: false
        default: ''

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Discover which apps are registered
  # ──────────────────────────────────────────────
  discover:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.find.outputs.apps }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Find registered apps
        id: find
        run: |
          if [ -n "${{ github.event.inputs.app_id }}" ]; then
            # Manual trigger for specific app
            APPS='["${{ github.event.inputs.app_id }}"]'
          else
            # Auto-discover all apps
            APPS=$(ls apps/*/app.json 2>/dev/null | xargs -I{} dirname {} | xargs -I{} basename {} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          echo "apps=$APPS" >> $GITHUB_OUTPUT
          echo "Discovered apps: $APPS"

  # ──────────────────────────────────────────────
  # Job 2: Build each app in parallel
  # ──────────────────────────────────────────────
  build:
    needs: discover
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        app: ${{ fromJson(needs.discover.outputs.apps) }}
      fail-fast: false  # Don't fail all apps if one fails

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # --- NEW: Setup Node.js for apk-mitm ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install System Dependencies
        run: |
          pip install -r requirements.txt
          npm install -g apk-mitm

      # ── Download ──
      - name: Check for updates & download
        id: check_version
        run: python run.py --app ${{ matrix.app }} --step download

# ── Tools (Dynamic Download) ──
      - name: Download Latest Apktool & UberSigner
        if: steps.check_version.outputs.update_needed == 'true'
        run: |
          # 1. Fetch Apktool (via redirect)
          # Get the final URL of the 'latest' release page
          APKTOOL_TAG=$(curl -Ls -o /dev/null -w %{url_effective} https://github.com/iBotPeaches/Apktool/releases/latest | awk -F'/' '{print $NF}')
          # Strip 'v' prefix if present to get version number
          APKTOOL_VER="${APKTOOL_TAG#v}"
          # Construct download URL (Standard pattern: apktool_X.Y.Z.jar)
          APKTOOL_URL="https://github.com/iBotPeaches/Apktool/releases/download/${APKTOOL_TAG}/apktool_${APKTOOL_VER}.jar"
          
          echo "Detected Apktool version: $APKTOOL_TAG"
          echo "Downloading from: $APKTOOL_URL"
          wget -q "$APKTOOL_URL" -O apktool.jar || { echo "::error::Failed to download Apktool from $APKTOOL_URL"; exit 1; }

          # 2. Fetch Uber APK Signer (via redirect)
          UBER_TAG=$(curl -Ls -o /dev/null -w %{url_effective} https://github.com/patrickfav/uber-apk-signer/releases/latest | awk -F'/' '{print $NF}')
          UBER_VER="${UBER_TAG#v}"
          UBER_URL="https://github.com/patrickfav/uber-apk-signer/releases/download/${UBER_TAG}/uber-apk-signer-${UBER_VER}.jar"
          
          echo "Detected UberSigner version: $UBER_TAG"
          echo "Downloading from: $UBER_URL"
          wget -q "$UBER_URL" -O ubersigner.jar || { echo "::error::Failed to download UberSigner from $UBER_URL"; exit 1; }

      # ── Decode ──
      - name: Decode APK
        if: steps.check_version.outputs.update_needed == 'true'
        run: java -jar apktool.jar d -f latest.apk -o build_output

      # ── Patch ──
      - name: Apply patch
        if: steps.check_version.outputs.update_needed == 'true'
        run: python run.py --app ${{ matrix.app }} --step patch

      # ── Repack ──
      - name: Repack APK
        if: steps.check_version.outputs.update_needed == 'true'
        run: java -jar apktool.jar b build_output -o patched_unsigned.apk

      # ── Sign ──
      - name: Decode Keystore
        if: steps.check_version.outputs.update_needed == 'true'
        env:
          RELEASE_KEYSTORE: ${{ secrets.RELEASE_KEYSTORE }}
        run: echo "$RELEASE_KEYSTORE" | base64 --decode > my_keystore.jks

      - name: Sign with UberApkSigner
        if: steps.check_version.outputs.update_needed == 'true'
        run: |
          java -jar ubersigner.jar \
            -a patched_unsigned.apk \
            --ks my_keystore.jks \
            --ksAlias ${{ secrets.KEY_ALIAS }} \
            --ksKeyPass ${{ secrets.KEY_PASSWORD }} \
            --ksPass ${{ secrets.KEYSTORE_PASSWORD }}

          mkdir -p release
          mv patched_unsigned-aligned-signed.apk release/${{ matrix.app }}-patched-${{ steps.check_version.outputs.new_version }}.apk

      # ── Status tracking ──
      - name: Update status on success
        if: steps.check_version.outputs.update_needed == 'true' && success()
        run: |
          python -c "
          from core.utils import update_status
          update_status('apps/${{ matrix.app }}/status.json', success=True)
          "

      # --- NEW: Explicitly update version file only on success ---
      - name: Update version file
        if: steps.check_version.outputs.update_needed == 'true' && success()
        run: echo "${{ steps.check_version.outputs.new_version }}" > apps/${{ matrix.app }}/version.txt

      - name: Update status on failure
        if: failure()
        run: |
          FAILED_VER="${{ steps.check_version.outputs.new_version || 'unknown' }}"
          python -c "
          from core.utils import update_status
          update_status('apps/${{ matrix.app }}/status.json', success=False, failed_version='$FAILED_VER', error_message='Patching or building failed')
          "

      # ── Commit changes ──
      - name: Commit and Push version & status
        if: always()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # משוך שינויים אחרונים קודם, ללא rebase
          git pull origin ${{ github.ref_name }}
          git add apps/${{ matrix.app }}/version.txt apps/${{ matrix.app }}/status.json
          # אם יש קונפליקטים, ה-checkout --ours יפתור אותם אוטומטית וישמור על הגרסה של הבוט
          git commit -m "[${{ matrix.app }}] Update to ${{ steps.check_version.outputs.new_version || 'status update' }}" || git checkout --ours apps/${{ matrix.app }}/*
          git push origin HEAD:${{ github.ref_name }}

      # ── Tag & Release ──
      - name: Create tag and Force Push
        if: steps.check_version.outputs.update_needed == 'true' && success()
        run: |
          git tag -f ${{ matrix.app }}-v${{ steps.check_version.outputs.new_version }}
          git push origin --tags --force

      - name: Create GitHub Release
        if: steps.check_version.outputs.update_needed == 'true' && success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.app }}-v${{ steps.check_version.outputs.new_version }}
          name: "${{ matrix.app }} ${{ steps.check_version.outputs.new_version }}"
          files: release/*.apk
          body: "Automated patch for ${{ matrix.app }} version ${{ steps.check_version.outputs.new_version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # 
  # Job 3: Update apps.json listing
  # 
  update-listing:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Update listing
        run: python run.py --update-listing

      - name: Commit & Push apps.json
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git pull origin ${{ github.ref_name }}
          git add apps.json
          git commit -m "update apps.json listing [skip ci]" || git checkout --ours apps.json
          git push origin HEAD:${{ github.ref_name }}
